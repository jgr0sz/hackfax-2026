<!-- Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved. -->
<!-- SPDX-License-Identifier: MIT-0 -->
<html>
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/maplibre-gl@4.7.1/dist/maplibre-gl.min.css"
      rel="stylesheet"
    />
    <style>
      body { margin: 0; }
      #map { height: 100vh; position: relative; }
      
      button.maplibregl-ctrl-compass { display: none !important; }

      /* Overlay UI */
      .ui {
        position: absolute;
        top: 14px;
        right: 14px;
        z-index: 10;
        font-family: system-ui, sans-serif;
        width: 340px;
        max-height: calc(100vh - 28px);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      }
      .feed-panel { flex: 1; min-height: 0; display: flex; flex-direction: column; }
      .feed-panel h3 { margin: 0 0 8px; font-size: 14px; }
      .feed-list { overflow-y: auto; max-height: 280px; }
      .feed-item {
        padding: 10px;
        margin-bottom: 8px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #6c757d;
        font-size: 12px;
      }
      .feed-item.verified { border-left-color: #28a745; }
      .feed-item .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 6px; }
      .feed-item .badge.verified-badge { background: #28a745; color: white; }
      .feed-item .badge.unverified-badge { background: #6c757d; color: white; }
      .feed-item .vote-row { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
      .feed-item .vote-row button { width: auto; padding: 4px 8px; font-size: 12px; }
      .feed-item .vote-score { font-weight: bold; min-width: 24px; }
      .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      .header-row .user-info { font-size: 12px; color: #555; }
      .header-row button { width: auto; padding: 6px 12px; font-size: 12px; }
      .row { display: flex; gap: 8px; }
      button, input, select, textarea {
        width: 100%;
        padding: 8px;
        border-radius: 10px;
        border: 1px solid #ddd;
        box-sizing: border-box;
        font-size: 14px;
      }
      textarea { min-height: 90px; resize: vertical; }
      label { display:block; margin-top:10px; font-size: 12px; }

      #form { display: none; margin-top: 10px; }
      #status {
        white-space: pre-wrap;
        font-size: 12px;
        margin-top: 10px;
        padding: 8px;
        border-radius: 10px;
        background: #f6f6f6;
        border: 1px solid #eee;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <!-- Overlay controls (map stays visible) -->
    <div class="ui">
      <div class="panel">
        <div class="header-row">
          <span class="user-info" id="userInfo">‚Äî</span>
          <span>
            <a href="/admin" id="adminLink" style="display:none; margin-right:8px; font-size:12px;">Admin</a>
            <button id="logoutBtn" type="button">Logout</button>
          </span>
        </div>
        <div class="row">
          <button id="reportBtn" type="button">Report incident (auto locate)</button>
          <button id="manualBtn" type="button">Manual</button>
        </div>

        <div id="form">
          <label>Date</label>
          <input type="date" id="date" required />
          <label>Time</label>
          <input type="time" id="time" />

          <label>Severity</label>
          <select id="severity" required>
            <option value="">Select‚Ä¶</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>

          <label>Details</label>
          <textarea id="details" placeholder="What happened?" required></textarea>

          <div class="row" style="margin-top:10px;">
            <button id="submitBtn" type="button">Submit</button>
            <button id="cancelBtn" type="button">Cancel</button>
          </div>
        </div>

        <div id="status">Ready.</div>
      </div>
      <div class="panel feed-panel">
        <h3>Feed (within 0.5 mi)</h3>
        <div id="feedList" class="feed-list">Loading‚Ä¶</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@4.7.1/dist/maplibre-gl.min.js"></script>
    <script>
      let map;
      let marker = null;
      let coords = null; // { latitude, longitude, accuracyMeters } or null
      let userLocationMarker = null; // persistent user location indicator
      let reportMarkers = []; // pins for reports on the map

      const statusEl = document.querySelector("#status");
      const formEl = document.querySelector("#form");

      const reportBtn = document.querySelector("#reportBtn");
      const manualBtn = document.querySelector("#manualBtn");
      const submitBtn = document.querySelector("#submitBtn");
      const cancelBtn = document.querySelector("#cancelBtn");

      const dateEl = document.querySelector("#date");
      const timeEl = document.querySelector("#time");
      const severityEl = document.querySelector("#severity");
      const detailsEl = document.querySelector("#details");
      const feedListEl = document.querySelector("#feedList");
      const userInfoEl = document.querySelector("#userInfo");
      const logoutBtn = document.querySelector("#logoutBtn");

      let currentUser = null;

      function setStatus(msg) { statusEl.textContent = msg; }

      function escapeHtml(s) {
        if (s == null || s === "") return "";
        const div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }
      function reportPopupHtml(report) {
        const sev = (report.severity || "‚Äî").toLowerCase();
        const dateTimeStr = formatReportDateTime(report.date, report.created_at);
        const details = escapeHtml((report.details || "‚Äî").slice(0, 200));
        const address = escapeHtml(report.address || "‚Äî");
        const verified = report.verified ? '<span style="color:#28a745;">‚úì Verified</span>' : '<span style="color:#6c757d;">Unverified</span>';
        return `<div style="min-width:200px;max-width:280px;font-size:13px;">
          <div style="font-weight:bold;margin-bottom:6px;">${sev} ${verified}</div>
          <div style="color:#666;margin-bottom:4px;">üïê ${escapeHtml(dateTimeStr)}</div>
          <div style="color:#555;margin-bottom:4px;">üìç ${address}</div>
          <div style="margin-top:6px;">${details}</div>
        </div>`;
      }
      function clearReportMarkers() {
        reportMarkers.forEach(m => m.remove());
        reportMarkers = [];
      }
      function updateReportMarkers(reports) {
        if (!map) return;
        clearReportMarkers();
        (reports || []).forEach(report => {
          const loc = report.location;
          if (!loc || loc.latitude == null || loc.longitude == null) return;
          const m = new maplibregl.Marker({ color: "#e74c3c" })
            .setLngLat([loc.longitude, loc.latitude])
            .setPopup(new maplibregl.Popup({ offset: 25 }).setHTML(reportPopupHtml(report)))
            .addTo(map);
          reportMarkers.push(m);
        });
      }
      async function refreshReportMarkers() {
        try {
          const res = await fetch("/reports", { credentials: "same-origin" });
          if (res.ok) {
            const reports = await res.json();
            updateReportMarkers(reports);
          }
        } catch (e) {}
      }

      function formatReportDateTime(dateStr, createdStr) {
        if (!dateStr && !createdStr) return "‚Äî";
        let s = "";
        if (dateStr) {
          const d = dateStr.indexOf("T") >= 0 ? new Date(dateStr + (dateStr.length === 16 ? ":00" : "")) : new Date(dateStr + "T12:00:00");
          if (!isNaN(d.getTime())) {
            s = d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
            if (dateStr.indexOf("T") >= 0) s += ", " + d.toLocaleTimeString(undefined, { hour: "numeric", minute: "2-digit" });
          } else s = dateStr;
        }
        if (createdStr) {
          const c = new Date(createdStr);
          if (!isNaN(c.getTime())) s += (s ? " ¬∑ " : "") + "Reported " + c.toLocaleDateString(undefined, { month: "short", day: "numeric" }) + " at " + c.toLocaleTimeString(undefined, { hour: "numeric", minute: "2-digit" });
        }
        return s || dateStr || createdStr || "‚Äî";
      }

      async function loadUser() {
        try {
          const res = await fetch("/api/me", { credentials: "same-origin" });
          const data = await res.json();
          currentUser = data.user || null;
          if (userInfoEl) userInfoEl.textContent = currentUser ? currentUser.username + (currentUser.account_type === "admin" ? " (admin)" : "") : "‚Äî";
      const adminLink = document.getElementById("adminLink");
      if (adminLink) adminLink.style.display = currentUser && currentUser.account_type === "admin" ? "inline" : "none";
        } catch (e) { userInfoEl.textContent = "‚Äî"; }
      }
      logoutBtn.addEventListener("click", async () => {
        await fetch("/logout", { method: "POST", credentials: "same-origin" });
        window.location.href = "/login";
      });

      // Notification permission handling
      function requestNotificationPermission() {
        if (!("Notification" in window)) {
          console.log("Browser does not support notifications");
          return;
        }

        console.log("Notification permission status:", Notification.permission);

        if (Notification.permission === "granted") {
          console.log("Notification permission already granted, showing test");
          showTestNotification();
        } else if (Notification.permission !== "denied") {
          console.log("Requesting notification permission...");
          Notification.requestPermission().then((permission) => {
            console.log("Permission result:", permission);
            if (permission === "granted") {
              console.log("Permission granted, showing test notification");
              showTestNotification();
            }
          }).catch((err) => {
            console.error("Permission request error:", err);
          });
        } else {
          console.log("Notification permission was denied");
        }
      }

      function showTestNotification() {
        try {
          console.log("Creating notification...");
          
          // Blur window momentarily to ensure notification shows
          window.blur();
          
          const notification = new Notification("Incident Report System Ready", {
            body: "Notifications enabled for incident alerts",
            badge: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üìç</text></svg>",
            requireInteraction: false,
          });
          
          console.log("Notification created and displayed");
          
          notification.addEventListener("click", () => {
            window.focus();
            notification.close();
          });
          
          notification.addEventListener("error", (err) => {
            console.error("Notification error:", err);
          });
          
          // Refocus the window after a short delay
          setTimeout(() => window.focus(), 100);
          
        } catch (err) {
          console.error("Error showing notification:", err);
        }
      }

      function openForm() {
        formEl.style.display = "block";
        const now = new Date();
        dateEl.valueAsDate = now;
        if (timeEl) {
          timeEl.value = String(now.getHours()).padStart(2, "0") + ":" + String(now.getMinutes()).padStart(2, "0");
        }
        detailsEl.focus();
      }

      function closeForm() {
        formEl.style.display = "none";
        severityEl.value = "";
        detailsEl.value = "";
        if (timeEl) timeEl.value = "";
      }

      function setMarker(lat, lng) {
        if (!marker) marker = new maplibregl.Marker();
        marker.setLngLat([lng, lat]).addTo(map);
        map.flyTo({ center: [lng, lat], zoom: 15 });
      }

      function getCoords() {
        return new Promise((resolve, reject) => {
          if (!("geolocation" in navigator)) {
            return reject(new Error("Geolocation not supported by this browser."));
          }
          navigator.geolocation.getCurrentPosition(
            (pos) => resolve({
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude,
              accuracyMeters: pos.coords.accuracy,
            }),
            (err) => reject(err),
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        });
      }

      async function initializeMap() {
        const apiKey = "v1.public.eyJqdGkiOiI5MmM5Y2JiZi01ODkzLTQ4YjctYjRhMi1kZmIzMDE5ODY0NTkifUQq73oCDjCVqFZmlUScpz49Y-DkCHQpY_G-1SUlUbQ6m7yfHjuHcnPuzJlCovp_09O2h2aeKtx8beFImNyzOwZpEFsMQNCwteVAdG6kVM23YJVKLi9iPuG_3wTEEqAglJJhutTweD8FBEBQu0avg_o98zkb_aQWxk8NaW29kmFH4OH9M2j_FpcFcy1eY3khSPHOzrGsGj9ySSfe7KCEYD9DWA8SE6L8dr5WwPJmC547IRca2fHiWhidrOvAEKlv0sngOtyTMMEFeXBcTcvY56aCs5lMgnxlzqu9TKKdA3qzJjmhG1SNVE8gTP0HYM-JUCYIIP-c7swEx16p-D3VOyw.ZWU0ZWIzMTktMWRhNi00Mzg0LTllMzYtNzlmMDU3MjRmYTkx";
        const region = "us-east-1";

        // Try to get user location, fallback to default
        let mapCenter = [-123.1187, 49.2819]; // Default center
        try {
          const pos = await getCoords();
          mapCenter = [pos.longitude, pos.latitude];
          coords = pos; // Store initial user location
          console.log("Map centered on user location:", mapCenter);
        } catch (e) {
          console.log("Could not get user location, using default:", e.message);
        }

        map = new maplibregl.Map({
          container: "map",
          center: mapCenter,
          zoom: 15,
          style: `https://maps.geo.${region}.amazonaws.com/v2/styles/Standard/descriptor?key=${apiKey}`,
          validateStyle: false,
        });

        // Add zoom controls and user location button
        map.addControl(new maplibregl.NavigationControl(), "top-left");
        
        // Custom center/pin button for user location
        const centerBtn = document.createElement("button");
        centerBtn.textContent = "üìç";
        centerBtn.style.cssText = `
          position: absolute;
          top: 14px;
          left: 60px;
          z-index: 100;
          width: 40px;
          height: 40px;
          padding: 0;
          margin: 0;
          border: 1px solid #ccc;
          border-radius: 4px;
          background: white;
          cursor: pointer;
          font-size: 20px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        `;
        centerBtn.addEventListener("click", async () => {
          try {
            const pos = await getCoords();
            map.flyTo({ center: [pos.longitude, pos.latitude], zoom: 15 });
            // Update or create persistent user location marker
            if (userLocationMarker) {
              userLocationMarker.setLngLat([pos.longitude, pos.latitude]);
            } else {
              userLocationMarker = new maplibregl.Marker({ color: "blue" })
                .setLngLat([pos.longitude, pos.latitude])
                .setPopup(new maplibregl.Popup().setHTML("<strong>You are here</strong>"))
                .addTo(map);
            }
          } catch (e) {
            setStatus("Could not get location: " + e.message);
          }
        });
        document.getElementById("map").appendChild(centerBtn);

        // Create user location marker once map is loaded
        map.on("load", () => {
          if (coords) {
            userLocationMarker = new maplibregl.Marker({ color: "blue" })
              .setLngLat([coords.longitude, coords.latitude])
              .setPopup(new maplibregl.Popup().setHTML("<strong>You are here</strong>"))
              .addTo(map);
          }
        });

        // (Optional) allow user to click map to set report location
        // Useful if geolocation is denied or if they want a different spot.
        map.on("click", (e) => {
          // Only set location if they are currently reporting (form open)
          if (formEl.style.display !== "block") return;

          coords = {
            latitude: e.lngLat.lat,
            longitude: e.lngLat.lng,
            accuracyMeters: null,
          };
          setMarker(coords.latitude, coords.longitude);
          setStatus(
            `Location set from map click:\nlat=${coords.latitude.toFixed(6)} lng=${coords.longitude.toFixed(6)}\n\nFill in details and submit.`
          );
        });
      }

      reportBtn.addEventListener("click", async () => {
        setStatus("Requesting location‚Ä¶ (works on HTTPS or localhost)");
        coords = null;

        try {
          coords = await getCoords();
          setMarker(coords.latitude, coords.longitude);
          
          // Update or create persistent user location marker (blue)
          if (userLocationMarker) {
            userLocationMarker.setLngLat([coords.longitude, coords.latitude]);
          } else {
            userLocationMarker = new maplibregl.Marker({ color: "blue" })
              .setLngLat([coords.longitude, coords.latitude])
              .setPopup(new maplibregl.Popup().setHTML("<strong>You are here</strong>"))
              .addTo(map);
          }
          
          setStatus(
            `Location captured:\n` +
            `lat=${coords.latitude.toFixed(6)} lng=${coords.longitude.toFixed(6)} (¬±${Math.round(coords.accuracyMeters)}m)\n\n` +
            `Tip: you can also click the map to adjust the pin.`
          );
          openForm();
        } catch (e) {
          setStatus(
            `Could not get location: ${e.message || e}\n\n` +
            `Click "Manual" then click on the map to drop a pin.`
          );
        }
      });

      manualBtn.addEventListener("click", () => {
        coords = null; // force them to click map if they want a pin
        setStatus("Manual report: fill in details. If you want a location, click on the map to drop a pin.");
        openForm();
      });

      cancelBtn.addEventListener("click", () => {
        coords = null;
        setStatus("Canceled.");
        closeForm();
      });

      // Track which report IDs we've already notified (show each report only once)
      const notifiedReportIds = new Set();

      // Alert for nearby reports ‚Äî only show a notification once per report
      async function checkNearbyReports() {
        if (!coords || !coords.latitude || !coords.longitude) return;
        
        try {
          const res = await fetch("/reports/nearby", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({
              latitude: coords.latitude,
              longitude: coords.longitude,
              radius_miles: 0.5
            })
          });
          
          if (!res.ok) return;
          
          const data = await res.json();
          const nearby = data.nearby_reports || [];
          
          for (const item of nearby) {
            const report = item.report;
            const reportId = report && report.id;
            if (reportId != null && notifiedReportIds.has(reportId)) continue;
            if (reportId != null) notifiedReportIds.add(reportId);

            const distance = item.distance_miles;
            const severity = (report.severity != null && String(report.severity).trim() !== "")
              ? String(report.severity).toLowerCase()
              : "unknown";
            
            let severityEmoji = "‚ö†Ô∏è";
            if (severity === "low") severityEmoji = "üü°";
            else if (severity === "medium") severityEmoji = "üü†";
            else if (severity === "high") severityEmoji = "üî¥";
            else if (severity === "critical") severityEmoji = "üî¥üî¥";
            
            showAlertNotification(
              `${severityEmoji} ${severity.toUpperCase()} - ${distance.toFixed(2)} miles away`,
              `${report.details || ""}`,
              report
            );
            break; // show one notification per check
          }
        } catch (err) {
          console.error("Error checking nearby reports:", err);
        }
      }

      function showAlertNotification(title, body, report) {
        const severity = (report && report.severity != null && String(report.severity).trim() !== "")
          ? String(report.severity).toLowerCase()
          : "unknown";
        if (Notification.permission === "granted") {
          new Notification(title, { body: body });
        }
        if (severity === "high" || severity === "critical") {
          try {
            const alarm = new Audio("/static/audio/alarm.mp3");
            alarm.volume = 0.7;
            alarm.play().catch(() => {});
          } catch (e) {}
        }
      }

      submitBtn.addEventListener("click", async () => {
        if (!dateEl.value) return setStatus("Pick a date.");
        if (!severityEl.value) return setStatus("Pick a severity.");
        if (!detailsEl.value.trim()) return setStatus("Enter details.");

        let reportDate = dateEl.value;
        if (timeEl && timeEl.value) reportDate = dateEl.value + "T" + timeEl.value;

        const payload = {
          date: reportDate,
          severity: severityEl.value,
          location: coords ?? { latitude: null, longitude: null, accuracyMeters: null },
          details: detailsEl.value.trim(),
        };

        console.log("SUBMIT - Severity selected:", severityEl.value);
        setStatus("Submitting report‚Ä¶");

        try {
          const res = await fetch("/report", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify(payload),
          });

          const body = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${JSON.stringify(body)}`);

          setStatus("Submitted ‚úÖ (report saved)");
          closeForm();
          
          checkNearbyReports();
          fetchFeed();
          refreshReportMarkers();
        } catch (err) {
          setStatus("Submit failed ‚ùå\n" + err.message);
        }
      });

      // Feed: fetch within 0.5 mi, show verified/unverified, voting; poll every 30s
      async function fetchFeed() {
        if (!coords || !coords.latitude || !coords.longitude) {
          feedListEl.textContent = "Enable location to see feed.";
          return;
        }
        try {
          const res = await fetch("/feed", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({
              latitude: coords.latitude,
              longitude: coords.longitude
            })
          });
          if (!res.ok) { feedListEl.textContent = "Could not load feed."; return; }
          const data = await res.json();
          const feed = data.feed || [];
          if (feed.length === 0) {
            feedListEl.innerHTML = "<div style='padding:8px;color:#666;'>No events within 0.5 miles.</div>";
            return;
          }
          feedListEl.innerHTML = feed.map(({ report, distance_miles }) => {
            const sev = (report.severity || "").toLowerCase();
            const badgeClass = report.verified ? "verified-badge" : "unverified-badge";
            const badgeText = report.verified ? "Verified" : "Unverified";
            const itemClass = "feed-item" + (report.verified ? " verified" : "");
            const upCount = report.upvote_count != null ? report.upvote_count : 0;
            const downCount = report.downvote_count != null ? report.downvote_count : 0;
            const userVote = report.user_vote != null ? report.user_vote : null;
            const upActive = userVote === 1 ? " style='background:#28a745;color:white;'" : "";
            const downActive = userVote === -1 ? " style='background:#dc3545;color:white;'" : "";
            let verifyBtn = "";
            let deleteBtn = "";
            if (currentUser && currentUser.account_type === "admin") {
              if (!report.verified) verifyBtn = `<button type="button" class="verify-btn" data-id="${report.id}">Verify</button>`;
              deleteBtn = `<button type="button" class="delete-feed-btn" data-id="${report.id}" style="margin-left:auto;color:#dc3545;border-color:#dc3545;">Delete</button>`;
            }
            const fullAddr = report.address || "";
            const addr = fullAddr ? `<div style="margin-top:2px;font-size:11px;color:#555;" title="${fullAddr.replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;")}">üìç ${fullAddr.slice(0, 50)}${fullAddr.length > 50 ? "‚Ä¶" : ""}</div>` : "";
            const dateTimeStr = formatReportDateTime(report.date, report.created_at);
            return `<div class="${itemClass}" data-id="${report.id}">
              <span class="badge ${badgeClass}">${badgeText}</span>
              <strong>${sev}</strong> ¬∑ ${distance_miles} mi
              <div style="margin-top:2px;font-size:11px;color:#666;">üïê ${dateTimeStr}</div>
              ${addr}
              <div style="margin-top:4px;">${(report.details || "").slice(0, 80)}${(report.details || "").length > 80 ? "‚Ä¶" : ""}</div>
              <div class="vote-row">
                <button type="button" class="vote-up" data-id="${report.id}"${upActive}>‚Üë ${upCount}</button>
                <button type="button" class="vote-down" data-id="${report.id}"${downActive}>‚Üì ${downCount}</button>
                ${verifyBtn}
                ${deleteBtn}
              </div>
            </div>`;
          }).join("");
          feedListEl.querySelectorAll(".vote-up").forEach(btn => {
            btn.addEventListener("click", () => voteReport(parseInt(btn.dataset.id, 10), 1));
          });
          feedListEl.querySelectorAll(".vote-down").forEach(btn => {
            btn.addEventListener("click", () => voteReport(parseInt(btn.dataset.id, 10), -1));
          });
          feedListEl.querySelectorAll(".verify-btn").forEach(btn => {
            btn.addEventListener("click", () => verifyReport(parseInt(btn.dataset.id, 10)));
          });
          feedListEl.querySelectorAll(".delete-feed-btn").forEach(btn => {
            btn.addEventListener("click", () => deleteReport(parseInt(btn.dataset.id, 10)));
          });
        } catch (err) {
          feedListEl.textContent = "Error loading feed.";
        }
      }
      async function voteReport(reportId, vote) {
        try {
          const res = await fetch(`/reports/${reportId}/vote`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({ vote })
          });
          if (res.ok) fetchFeed();
        } catch (e) {}
      }
      async function verifyReport(reportId) {
        try {
          const res = await fetch(`/reports/${reportId}/verify`, { method: "POST", credentials: "same-origin" });
          if (res.ok) fetchFeed();
        } catch (e) {}
      }
      async function deleteReport(reportId) {
        if (!confirm("Delete this report?")) return;
        try {
          const res = await fetch(`/reports/${reportId}`, { method: "DELETE", credentials: "same-origin" });
          if (res.ok) { fetchFeed(); refreshReportMarkers(); }
        } catch (e) {}
      }

      // Initialize map and request notifications
      initializeMap().then(async () => {
        await loadUser();
        setTimeout(() => requestNotificationPermission(), 500);
        checkNearbyReports();
        fetchFeed();
        refreshReportMarkers();
        setInterval(fetchFeed, 30000);
        setInterval(refreshReportMarkers, 30000);
      }).catch((err) => {
        console.error("Map initialization error:", err);
      });
    </script>
  </body>
</html>
