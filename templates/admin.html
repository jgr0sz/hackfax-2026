<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Reports &amp; Users</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, sans-serif; background: #f0f2f5; }
    .top { background: #1a1a2e; color: #eee; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    .top a { color: #74c0fc; text-decoration: none; }
    .top a:hover { text-decoration: underline; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    h2 { margin: 0 0 12px; font-size: 1.25rem; }
    .section { background: white; border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    .badge.verified { background: #28a745; color: white; }
    .badge.unverified { background: #6c757d; color: white; }
    .badge.admin { background: #6f42c1; color: white; }
    .badge.user { background: #0dcaf0; color: #000; }
    .address { font-size: 12px; color: #555; max-width: 280px; }
    button, .btn { padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 13px; text-decoration: none; color: #333; display: inline-block; }
    button:hover, .btn:hover { background: #f0f0f0; }
    button.danger { border-color: #dc3545; color: #dc3545; }
    button.danger:hover { background: #dc3545; color: white; }
    .row-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    select.role { padding: 4px 8px; font-size: 13px; margin-right: 8px; }
    .empty { color: #666; padding: 16px; }
  </style>
</head>
<body>
  <div class="top">
    <span>Admin</span>
    <a href="/">← Map &amp; Feed</a>
  </div>
  <div class="container">
    <div class="section">
      <h2>Reports</h2>
      <div id="reportsTable">
        <div class="empty">Loading…</div>
      </div>
    </div>
    <div class="section">
      <h2>Users</h2>
      <div id="usersTable">
        <div class="empty">Loading…</div>
      </div>
    </div>
  </div>
  <script>
    async function api(path, opts = {}) {
      const res = await fetch(path, { credentials: 'same-origin', ...opts });
      if (res.status === 401 || res.status === 403) { window.location.href = '/login'; return; }
      return res;
    }
    async function loadReports() {
      const res = await api('/reports');
      if (!res) return;
      const reports = await res.json();
      const el = document.getElementById('reportsTable');
      if (!reports.length) { el.innerHTML = '<div class="empty">No reports.</div>'; return; }
      function fmtDt(d, c) {
        if (!d && !c) return '—';
        let s = '';
        if (d) {
          const hasT = (d + '').indexOf('T') >= 0;
          const x = hasT ? new Date((d + '').length === 16 ? d + ':00' : d) : new Date(d + 'T12:00:00');
          if (!isNaN(x.getTime())) s = hasT ? x.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' }) : x.toLocaleDateString(undefined, { dateStyle: 'short' }); else s = d;
        }
        if (c) {
          const y = new Date(c);
          if (!isNaN(y.getTime())) s += (s ? ' <br><small>Reported ' : '') + y.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' }) + '</small>';
        }
        return s || d || c || '—';
      }
      el.innerHTML = '<table><thead><tr><th>ID</th><th>Date / Time</th><th>Severity</th><th>Address</th><th>Details</th><th>Verified</th><th>Actions</th></tr></thead><tbody>' +
        reports.map(r => {
          const addr = (r.address || '—').slice(0, 60) + ((r.address || '').length > 60 ? '…' : '');
          const details = (r.details || '—').slice(0, 40) + ((r.details || '').length > 40 ? '…' : '');
          return `<tr>
            <td>${r.id}</td>
            <td>${fmtDt(r.date, r.created_at)}</td>
            <td>${r.severity || '—'}</td>
            <td class="address" title="${(r.address || '').replace(/"/g, '&quot;')}">${addr}</td>
            <td title="${(r.details || '').replace(/"/g, '&quot;')}">${details}</td>
            <td><span class="badge ${r.verified ? 'verified' : 'unverified'}">${r.verified ? 'Verified' : 'Unverified'}</span></td>
            <td><div class="row-actions"><button type="button" class="danger delete-report" data-id="${r.id}">Delete</button></div></td>
          </tr>`;
        }).join('') + '</tbody></table>';
      el.querySelectorAll('.delete-report').forEach(btn => {
        btn.addEventListener('click', () => deleteReport(parseInt(btn.dataset.id, 10)));
      });
    }
    async function deleteReport(id) {
      if (!confirm('Delete this report?')) return;
      const res = await api('/reports/' + id, { method: 'DELETE' });
      if (res && res.ok) loadReports();
    }
    async function loadUsers() {
      const res = await api('/admin/users');
      if (!res) return;
      const data = await res.json();
      const users = data.users || [];
      const el = document.getElementById('usersTable');
      if (!users.length) { el.innerHTML = '<div class="empty">No users.</div>'; return; }
      el.innerHTML = '<table><thead><tr><th>ID</th><th>Username</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead><tbody>' +
        users.map(u => {
          return `<tr>
            <td>${u.id}</td>
            <td>${u.username}</td>
            <td><span class="badge ${u.account_type === 'admin' ? 'admin' : 'user'}">${u.account_type}</span></td>
            <td>${(u.created_at || '—').slice(0, 10)}</td>
            <td><div class="row-actions">
              <select class="role" data-id="${u.id}">
                <option value="user" ${u.account_type === 'user' ? 'selected' : ''}>user</option>
                <option value="admin" ${u.account_type === 'admin' ? 'selected' : ''}>admin</option>
              </select>
              <button type="button" class="danger delete-user" data-id="${u.id}">Delete</button>
            </div></td>
          </tr>`;
        }).join('') + '</tbody></table>';
      el.querySelectorAll('.role').forEach(sel => {
        sel.addEventListener('change', () => updateUserRole(parseInt(sel.dataset.id, 10), sel.value));
      });
      el.querySelectorAll('.delete-user').forEach(btn => {
        btn.addEventListener('click', () => deleteUser(parseInt(btn.dataset.id, 10)));
      });
    }
    async function updateUserRole(userId, account_type) {
      const res = await api('/admin/users/' + userId, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ account_type })
      });
      if (res && !res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.error || 'Failed to update');
      }
      loadUsers();
    }
    async function deleteUser(id) {
      if (!confirm('Delete this user? Their reports will be kept but unlinked.')) return;
      const res = await api('/admin/users/' + id, { method: 'DELETE' });
      if (res && res.ok) loadUsers();
      else if (res) { const e = await res.json().catch(() => ({})); alert(e.error || 'Failed'); }
    }
    loadReports();
    loadUsers();
  </script>
</body>
</html>
